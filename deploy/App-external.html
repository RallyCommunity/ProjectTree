<!DOCTYPE html>
<html>
<head>
    <title>ProjectTree</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.ui.popover.UserPopover",{alias:"widget.rallyuserpopover",extend:Rally.ui.popover.ListViewPopover,id:"user-popover",cls:"userstory-popover",title:"Users",titleIconCls:"icon-story",constructor:function(config){var app=Ext.getCmp("projectApp"),fieldName=app.getSetting("userGroup")||"TeamMembers",filters=[{property:"WorkspacePermission",operator:"<",value:"Workspace Admin"}];app.getSetting("projectAdminsOnly")===!0&&(filters=[{property:"WorkspacePermission",value:"Project Admin"}]),config.listViewConfig=Ext.merge({model:Ext.identityFn("User"),childField:fieldName,addNewConfig:null,gridConfig:{enableEditing:!1,storeConfig:{context:config.context,filters:filters,fetch:!0,listeners:{load:this._onStoreLoad,scope:this}},columnCfgs:[{dataIndex:"DisplayName",width:90},{dataIndex:"EmailAddress",flex:90},{dataIndex:"Phone",width:180},{dataIndex:"UserName",width:180}]}},config.listViewConfig),this.callParent(arguments)}}),Ext.define("Rally.ui.tree.extendedTreeItem",{alias:"widget.extendedTreeItem",extend:"Rally.ui.tree.TreeItem",config:{displayedFields:["Name","Description","TeamMembers"]},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<div class="textContent ellipses">{[this.getFormattedId()]} {[this.getSeparator()]}{Name} ({[this.getOwner()]})</div>','<div class="rightSide">',"</div>",{canDrag:function(){return me.getCanDrag()},getActionsGear:function(){return me._buildActionsGearHtml()},getFormattedId:function(){var record=me.getRecord();return record.getField("FormattedID")?Rally.ui.renderer.RendererFactory.renderRecordField(record,"FormattedID"):""},getSeparator:function(){return this.getFormattedId()?"- ":""},getOwner:function(){var record=me.getRecord();return record.getField("Owner")?Rally.ui.renderer.RendererFactory.renderRecordField(record,"Owner"):""}})},draw:function(){var me=this;this.content&&this.content.destroy();var cls="treeItemContent";this.getSelectable()&&(cls+=" selectable"),this.expander?this.toggleExpander():this.expander=this.drawExpander(),this.insert(1,{xtype:"container",itemId:"treeItemContent",cls:cls,layout:{type:"hbox"},items:[{xtype:"component",renderTpl:this.getContentTpl(),renderData:this.getRenderData(),listeners:{afterrender:function(){this.setupListeners(),this.fireEvent("draw")},scope:this}},{xtype:"fieldcontainer",itemId:"userInfoRecord",layout:{type:"anchor"},defaults:{layout:"100%"},style:{marginLeft:"50px",border:15},listeners:{afterrender:function(cmp){var treeItem=me,record=me.getRecord(),app=this.up("#projectApp"),filters=[{property:"WorkspacePermission",operator:"<",value:"Workspace Admin"}];app.getSetting("projectAdminsOnly")===!0&&(filters=[{property:"WorkspacePermission",value:"Project Admin"}]);var fieldName=app.getSetting("userGroup")||"TeamMembers";record.getCollection(fieldName,{filters:filters}).load().then({success:function(data){var popOver,thisPopoverCfg={record:record,target:cmp.getTargetEl(),field:fieldName,title:fieldName,autoShow:!0};data.length>0&&cmp.getTargetEl().on("click",function(){Ext.create("Rally.ui.popover.UserPopover",thisPopoverCfg)}),cmp.suspendLayouts(),_.each(data,function(member){var mseSelected,user={xtype:"textfield",readOnly:!0,style:{marginLeft:"10px"},value:member.get("_refObjectName")};cmp.add(user)}),cmp.resumeLayouts()}})}}}]})}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",itemId:"projectApp",id:"projectApp",stateful:!0,stateId:"projectApp-"+Ext.id(),getSettingsFields:function(){return[{xtype:"rallycheckboxfield",fieldLabel:"Show Project Admins Only",labelWidth:200,name:"projectAdminsOnly"},{xtype:"radiogroup",fieldLabel:"User Type Selection",name:"typeGroup",columns:1,items:[{boxLabel:"Editors",name:"userGroup",inputValue:"Editors"},{boxLabel:"Team Members",name:"userGroup",inputValue:"TeamMembers",checked:!0}]}]},launch:function(){var app=this,pt=Ext.create("Rally.ui.tree.ProjectTree",{config:{treeItemConfigForRecordFn:function(record){return"workspace"===record.get("_type")?{xtype:"rallyplaintreeitem"}:{xtype:"extendedTreeItem",selectable:!0}},topLevelStoreConfig:{fetch:["Name","State","Workspace"],filters:[{property:"State",value:"Open"},{property:"Projects.State",value:"Open"}],sorters:[{property:"Name",direction:"ASC"}],context:function(){app._getContext(app)}},childItemsStoreConfigForParentRecordFn:function(record){var storeConfig={fetch:["Name","Description","Owner","Children:summary[State]","State","Workspace"],hydrate:["Owner"],sorters:[{property:"Name",direction:"ASC"}]};return"workspace"===record.get("_type")?Ext.apply(storeConfig,{filters:[{property:"Parent",value:"null"}],context:{workspace:record.get("_ref"),project:null}}):Ext.apply(storeConfig,{filters:[{property:"Parent",value:record.get("_ref")}],context:{workspace:record.get("Workspace")._ref,project:null}})}}});this.add(pt)}});

            Rally.launchApp('CustomApp', {
                name:"ProjectTree",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
